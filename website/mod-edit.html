{% extends 'html-partials/standart.html' %}
{% block content %}
    <div id="main-mod-edit" style="opacity: 0;">
      <article style="display: flex; width: 900pt; max-width: 100%; justify-content: center; padding: 0;">
        <div class="standart-panel" style="position: absolute; display: flex; background: #34374500; padding: 3pt;">
          <div class="navigation standart-panel" style="margin: 0; background: rgb(26, 27, 38);" variants='in-mod-page, in-catalog-view, params-mod'>
            <button id="start-page-button" variant="in-mod-page" onclick="Pager.change(this)">
              <img src="/assets/images/home-ico.svg" alt="–ò–∫–æ–Ω–∫–∞ '–¥–æ–º–æ–π'">
            </button>
            <button style="margin-left: 2pt;" variant="in-catalog-view" onclick="Pager.change(this)">
              <img src="/assets/images/image-ico.svg" alt="–ò–∫–æ–Ω–∫–∞ '–∫–∞—Ç–∞–ª–æ–≥'">
            </button>
            <button style="margin-left: 2pt;" variant="params-mod" onclick="Pager.change(this)">
              <img src="/assets/images/params-ico.svg" alt="–ò–∫–æ–Ω–∫–∞ '–ø–∞—Ä–∞–º–µ—Ç—Ä—ã'">
            </button>
          </div>
          <div class="navigation standart-panel" style="margin: 0; background: rgb(26, 27, 38); margin-left: 5pt;">
            <button style="background-color: #FFF8D3;" onclick="saveChanges()">
              <img src="/assets/images/save-ico.svg" alt="–ò–∫–æ–Ω–∫–∞ '—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å'">
            </button>
          </div>
        </div>

        <div style="width: 100%; display: flex; margin: 3.5pt;" id="page-in-mod-page">
          <div style="width: 70%;">
            <div style="display: flex; margin-left: -4pt; margin-top: -4pt; height: 57px;">
              <input dynamlen empty-width="160pt" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã" type="text" class="title-mod" startdata="{{ info['result']['name'] }}" value="{{ info['result']['name'] }}">
              <button onclick="toggleNextPublic()" class="public-mod-toggle anime-scale" startdata="{{ info['result']['public'] }}" public-mode="{{ info['result']['public'] }}">
                <img src="" alt="–ò–∫–æ–Ω–∫–∞ —Ä–µ–∂–∏–º–∞ –ø—É–±–ª–∏—á–Ω–æ—Å—Ç–∏">
              </button>
            </div>
              
            <div style="margin: 5pt;">
              <div style="display: flex; justify-content: space-between; padding: 5pt;">
                <div class="navigation">
                  <button onclick="fullEditView(false)">
                    <img src="/assets/images/edit-ico.svg" alt="–ò–∫–æ–Ω–∫–∞ '—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ'">
                  </button>
                  
                  <button onclick="fullEditView(true)">
                    <img src="/assets/images/eye-ico.svg" alt="–ò–∫–æ–Ω–∫–∞ '–ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä'">
                  </button>
                </div>

                <div class="navigation">
                  <button onclick="toggleHelpMode($(this))">
                    <img src="/assets/images/info-ico.svg" alt="–ò–∫–æ–Ω–∫–∞ '—Ç—É—Ç–æ—Ä–∏–∞–ª'">
                  </button>
                </div>
              </div>

              {% with limit=10000, placeholder='–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!(', init_text=info['result']['description'] %}
                {% include 'html-partials/desc-edit.html' %}
              {% endwith %} 
              
              <article id="mod-description" style="display: none;"></article>
            </div>
          </div>

          <div style="width: 30%;">
            {% include 'html-partials/screenshots-edit.html' %}
            
            {% with game=info["result"]["game"]["id"] %}
              {% include 'html-partials/tags-edit.html' %}
            {% endwith %}

            {% include 'html-partials/mod-dependence-edit.html' %}
          </div>
        </div>

        <div id="page-in-catalog-view">
          <div class="" style="display: flex; margin-top: 50pt;">
            <div class="cards" style="width: auto;">
              <div class="card" id="{{ info['result']['id'] }}">
                <div class="card-click">
                  <div class="card__image-holder">
                    <img class="card__image title-card-img" alt="–ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ª–æ–≥–æ—Ç–∏–ø –º–æ–¥–∞" id="preview-logo-card-647960" onerror="this.src='/assets/images/image-not-found.webp'">
                  </div>
                  <div class="card-params-list">
                    <a class="tag-link card-params-list-tag" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥–æ–≤ –¥–ª—è –∏–≥—Ä—ã">üì¶{{ info['result']['size'] }}</a>
                  </div>
                  <div class="card-title">
                    <h2 id="titlename{{ info['result']['id'] }}" title="{{ info['result']['name'] }}">{{ info['result']['name'] }}</h2>
                  </div>
                </div>
                <div class="card-flap flap1" id="card-flap{{ info['result']['id'] }}">
                  <div class="card-description">{{ info['result']['short_description'] }}</div>
                  <div class="flap-buttons">
                    <a id="tomodlink{{ info['result']['id'] }}" class="button-card button-flap">
                      <img src="/assets/images/arrow.webp" class="img-to-mod">
                    </a>
                    <button id="togamelink{{ info['result']['id'] }}" onclick="cardCancel({{ info['result']['id'] }})" class="button-cancel button-flap" title="–ó–∞–≤–µ—Ä–Ω—É—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É">
                      <img src="/assets/images/cancel.webp" class="img-to-mod">
                    </button>
                  </div>
                </div>
              </div>
              <script>
                $(document).ready(function() {
                  const $cardDescD = $('div.card-description')
                  const $shortDescD = $('div[limit=256]').find('textarea.editing')
                  
                  console.log($shortDescD, $cardDescD)

                  $('img.card__image').attr('src', $('a.slider__images-item[typecontent="logo"]').attr('href'))
                  $cardDescD.attr('cashData', $shortDescD.val())
                  $cardDescD.html(Formating.syntax2HTML($shortDescD.val()))

                  setInterval(function(){
                    const dataText = $shortDescD.val()

                    if ($cardDescD.attr('cashData') != dataText) {
                      $cardDescD.attr('cashData', dataText)
                      $cardDescD.html(Formating.syntax2HTML(dataText))
                    }
                  }, 300)
                })
              </script>
              <script>
                let zindex = 1;
                $("div.card-click").click(function(e){
                  e.preventDefault();

                  var isShowing = false;
              
                  if ($(this).parent().hasClass("show")) {
                    isShowing = true
                  }
              
                  if ($("div.cards").hasClass("showing")) {
                    // a card is already in view
                    $("div.card.show")
                      .removeClass("show");
              
                    if (isShowing) {
                      // this card was showing - reset the grid
                      $("div.cards")
                        .removeClass("showing");
                    } else {
                      // this card isn't showing - get in with it
                      $(this).parent()
                        .css({zIndex: zindex})
                        .addClass("show");
                    }
              
                    zindex=zindex+2;
              
                  } else {
                    // no cards in view

                    $("div.cards")
                      .addClass("showing");
                    $(this).parent()
                      .css({zIndex:zindex})
                      .addClass("show");
              
                    zindex=zindex+2;
                  }

                  const id = $(this).parent()[0].id;
                  $('#card-flap'+id).css("z-index", zindex+1);
                  $("div.panel").css({zIndex: zindex+1})
                });

                function cardCancel(id) {
                  document.getElementById(id).classList.remove("show");
                }
              </script>
            </div>

            {% with limit=256, placeholder='–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!(', init_text=info['result']['short_description'] %}
              {% include 'html-partials/desc-edit.html' %}
            {% endwith %} 
          </div>
        </div>

        <div id="page-params-mod">
          <div style="margin-top: 50pt;">
            –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Å—è–∫–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
          </div>
        </div>

        <style>
          #page-in-mod-page, #page-in-catalog-view, #page-params-mod, #main-mod-edit {
            transition: opacity 0.1s;
          }
          #main-mod-edit {
            display: flex; flex-direction: column; align-items: center;
          }
        </style>
      </article>
    </div>
    <script>
      $(document).ready(function() {
        setTimeout(function() {
          $('div#main-mod-edit').css("opacity", 1);
        }, 500)
      })
    </script>

    <style>
      article {
        background-color: var(--main-panel-on-page-background);
      }

      div.navigation {
        display: flex;
      }

      div.navigation > button {
        border-radius: 10px;
        background-color: #D9D9D9;
        border: none;
        width: 35pt;
        height: 35pt;
        margin: 1pt;
        transition: all 0.1s;
      }
      div.navigation > button:hover {
        background-color: #c5c5c5;
      }
      div.navigation > button:active {
        background-color: #b3b3b3;
      }

      div.navigation > button.toggle {
        background-color: #9899ac;
      }
      div.navigation > button.toggle:hover {
        background-color: #7e7f8f;
      }
      div.navigation > button.toggle:active {
        background-color: #6c6d7a;
      }
      
      div.standart-panel {
        background-color: var(--panel-on-page-background);
        border-radius: 5pt;
        padding: 3pt;
        margin-bottom: 3pt;
      }

      input.title-mod {
        border-radius: 0pt;
        border-top-left-radius: 10pt;

        background: #302E3F;
        border: solid #939393;
        color: white;

        max-width: calc(66% - 105pt);
        height: 100%;
        font-size: 20pt;
        transition: border background 0.1s;
      }
      input.title-mod:hover {
        border: solid #7e7e7e;
        background: #2b2938;
      }
      input.title-mod:focus {
        border: solid #6b6b6b;
        background: #252330;
      }

      button.public-mod-toggle {
        border-bottom-right-radius: 5pt;

        height: 100%;
        aspect-ratio: 1 / 1;

        background: #212029;
        border: solid #777777;
      }
      button.public-mod-toggle > img {
        color: #D9D9D9;
        width: 70%;
      }
      button.public-mod-toggle:hover {
        background: #1d1c24;
        border: solid #6e6e6e;
      }
      button.public-mod-toggle:active {
        background: #19181f;
        border: solid #646464;
      }

      #page-in-catalog-view {
        width: 100%;
      }
    </style>
    
    <script src='//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>

    <script src="/assets/scripts/vendors/edit-images-list-addon.js"></script>

    <script src="/assets/scripts/vendors/tags-edit.js"></script>
    <script src="/assets/scripts/vendors/dependence-edit.js"></script>
    
    <script src="/assets/scripts/images-list.js"></script>
    <script src="/assets/scripts/vendors/pager-logic.js"></script>

    <script>
      Pager.updateSelect.call(document.querySelector('#start-page-button'))
      window.addEventListener('popstate', function(event) {
        Pager.updateSelect.call(document.querySelector('#start-page-button'))
      });
    </script>

    <script>
      const $fullModDescView = $('article#mod-description')
      const $fullModDescEdit = $('div[limit=10000]#desc-edit')
      const $fullModDescEditArea = $fullModDescEdit.find('textarea.editing')

      const publicButton = $('button.public-mod-toggle')
      const publicIcon = publicButton.find('img')
      const iconSrcMapPublic = {
        0: ['/assets/images/svg/white/eye.svg', '–î–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º'],
        1: ['/assets/images/svg/white/link.svg', '–î–æ—Å—Ç—É–ø–µ–Ω –ø–æ —Å—Å—ã–ª–∫–µ'],
        2: ['/assets/images/svg/white/lock.svg', '–î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞–º'],
      }
      toggleNextPublic(false)

      function toggleNextPublic(next = true) {
        if (next) {
          publicButton.attr('public-mode', (parseInt(publicButton.attr('public-mode')) + 1) % 3); 
        }
        publicIcon.attr('src', iconSrcMapPublic[publicButton.attr('public-mode')][0])
        publicButton.attr('title', iconSrcMapPublic[publicButton.attr('public-mode')][1])
      }

      function fullEditView(mode) {
        if (mode) {
          $fullModDescEdit.hide()
          $fullModDescView.show()

          console.log($fullModDescEditArea.val())

          $fullModDescView.html(Formating.syntax2HTML($fullModDescEditArea.val()))
        } else {
          $fullModDescEdit.show()
          $fullModDescView.hide()
        }
      }

      function toggleHelpMode(button) {
        if ($fullModDescEditArea.hasAttr('tutorial')) {
          button.removeClass('toggle')

          $fullModDescEditArea.val($fullModDescEditArea.attr('tutorial'))
          $fullModDescEditArea.removeAttr('tutorial')
        } else {
          button.addClass('toggle')

          $fullModDescEditArea.attr('tutorial', $fullModDescEditArea.val())
          $fullModDescEditArea.val('[h1]–ì–∞–π–¥ –ü–æ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—é![/h1]\n\n–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –≤ [b]–ø–æ–ª–Ω–æ–º[/b] –æ–ø–∏—Å–∞–Ω–∏–∏ –º–æ–¥–∞, —Ç–∞–∫ –∏ –≤ [i]–∫–æ—Ä–æ—Ç–∫–æ–º[/i].\n\n–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç 1 –¥–æ 6 (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É).\n–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –≤–∏–¥–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –∫–∞–∫ –≤–∏–¥–∞ https://openworkshop.su , —Ç–∞–∫ –∏ [url=https://openworkshop.su]—Ç–µ–∫—Å—Ç–∞ —Å –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–æ–π[/url]\n\n–¢–∞–∫ –∂–µ –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:\n[img]https://cdn.akamai.steamstatic.com/steam/apps/105600/header.jpg?t=1666290860[/img]\n\n–ê –µ—â—ë –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫:\n[list]\n[*] –ü–µ—Ä–≤—ã–π –ø—É–Ω–∫—Ç\n[*] –í—Ç–æ—Ä–æ–π –ø—É–Ω–∫—Ç\n[/list]\n\n[h5]–£–¥–∞—á–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ![/h5]')
        }

        fullDescUpdate($fullModDescEditArea)
        $fullModDescView.html(Formating.syntax2HTML($fullModDescEdit.find('textarea.editing').val()))
      }
    </script>

    <script>
    const modID = {{ info['result']['id'] }}

    /* =========================
      helper
    ========================= */
    async function post(url, body = null) {
      try {
        const res = await fetch(url, { method: 'POST', body, credentials: 'include' })
        const data = await res.json().catch(() => null)
        if (res.status !== 202) throw data || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞'
        return data
      } catch (e) {
        new Toast({ title: '–û—à–∏–±–∫–∞', text: e, theme: 'danger' })
        throw e
      }
    }

    function diff(value, start) {
      return { val: value, changed: value != start }
    }

    /* =========================
      collect base mod
    ========================= */
    function collectModChanges() {
      const title = $('input.title-mod')
      const shortDesc = $('div[limit=256] textarea.editing')
      const fullDesc = $('div[limit=10000] textarea.editing')
      const pub = $('button.public-mod-toggle')

      return {
        mod_name: diff(title.val(), title.attr('startdata')),
        mod_short_description: diff(shortDesc.val(), shortDesc.attr('startdata')),
        mod_description: diff(fullDesc.hasAttr('tutorial') ? fullDesc.attr('tutorial') : fullDesc.val(), fullDesc.attr('startdata')),
        mod_public: diff(pub.attr('public-mode'), pub.attr('startdata'))
      }
    }

    function buildFormData(changes) {
      const fd = new FormData()
      fd.append('mod_id', modID)
      for (const [k, v] of Object.entries(changes)) if (v.changed) fd.append(k, v.val)
      return fd
    }

    async function updateMod(changes) {
      if (!Object.values(changes).some(v => v.changed)) return
      await post('{{ manager_address }}/edit/mod', buildFormData(changes))
    }

    /* =========================
      logos
    ========================= */
    function getChangesLogos() {
      const box = $('ul.js__slider__images.slider__images')
      const res = { new: [], changed: [], deleted: [] }

      box.find('a').each(function () {
        const el = $(this)
        if (el.attr('idimg')?.startsWith('new-screenshot-')) {
          res.new.push({ type: el.attr('typecontent'), url: el.attr('href') })
          return
        }
        if (el.hasClass('deleted-user-screenshot')) {
          res.deleted.push(el.attr('idimg'))
          return
        }
        if (el.attr('starthref') != el.attr('href') || el.attr('starttypecontent') != el.attr('typecontent')) {
          const c = { id: el.attr('idimg') }
          if (el.attr('starthref') != el.attr('href')) c.url = el.attr('href')
          if (el.attr('starttypecontent') != el.attr('typecontent')) c.type = el.attr('typecontent')
          res.changed.push(c)
        }
      })
      return res
    }

    async function modUpdateLogos(logos) {
      const addUrl = '{{ manager_address }}/add/resource'
      const editUrl = '{{ manager_address }}/edit/resource?resource_id='
      const delUrl = '{{ manager_address }}/delete/resource?resource_id='

      for (const l of logos.new) {
        const fd = new FormData()
        fd.append('resource_type_name', l.type)
        fd.append('resource_url', l.url)
        fd.append('resource_owner_id', modID)
        await post(addUrl, fd)
      }

      for (const l of logos.changed) {
        const fd = new FormData()
        if (l.type) fd.append('resource_type', l.type)
        if (l.url) fd.append('resource_url', l.url)
        await post(editUrl + l.id, fd)
      }

      for (const id of logos.deleted) {
        await post(delUrl + id)
      }
    }

    /* =========================
      tags
    ========================= */
    function getChangesTags() {
      const box = $('div#tags-edit-selected-tags')
      const res = { new: [], deleted: [] }

      box.find('div').each(function () {
        const el = $(this)
        if (el.hasAttr('saved')) {
          if (el.hasClass('none-display')) res.deleted.push(el.attr('tagid'))
        } else {
          res.new.push(el.attr('tagid'))
        }
      })
      return res
    }

    async function modUpdateTags(tags) {
      const base = '{{ manager_address }}/association/mod/tag?mod_id=' + modID
      for (const id of tags.new) await post(`${base}&mode=true&tag_id=${id}`)
      for (const id of tags.deleted) await post(`${base}&mode=false&tag_id=${id}`)
    }

    /* =========================
      dependencies
    ========================= */
    function getChangesDependence() {
      const box = $('#mod-dependence-selected')
      const res = { new: [], deleted: [] }

      box.find('div.mod-dependence').each(function () {
        const el = $(this)
        if (el.hasAttr('saved')) {
          if (el.hasClass('none-display')) res.deleted.push(el.attr('modid'))
        } else {
          res.new.push(el.attr('modid'))
        }
      })
      return res
    }

    async function modUpdateDependecie(dep) {
      const base = '{{ manager_address }}/association/mod/dependencie?mod_id=' + modID
      for (const id of dep.new) await post(`${base}&mode=true&dependencie=${id}`)
      for (const id of dep.deleted) await post(`${base}&mode=false&dependencie=${id}`)
    }

    /* =========================
      saveChanges main
    ========================= */
    async function saveChanges() {
      const base = collectModChanges()
      const logos = getChangesLogos()
      const tags = getChangesTags()
      const deps = getChangesDependence()

      const has =
        Object.values(base).some(v => v.changed) ||
        logos.new.length || logos.changed.length || logos.deleted.length ||
        tags.new.length || tags.deleted.length ||
        deps.new.length || deps.deleted.length

      if (!has) {
        new Toast({ title: '–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å', text: '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π', theme: 'info' })
        return
      }

      await updateMod(base)
      if (logos.new.length || logos.changed.length || logos.deleted.length) await modUpdateLogos(logos)
      if (tags.new.length || tags.deleted.length) await modUpdateTags(tags)
      if (deps.new.length || deps.deleted.length) await modUpdateDependecie(deps)

      new Toast({ title: '–ì–æ—Ç–æ–≤–æ', text: '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', theme: 'success' })
      location.reload()
    }
    </script>



{% endblock %}

{% block title %}
{{ info['result']['name'] }} - edit Open Mod
{% endblock %}

{% block description %}
{{ info['result']['short_description'] }}
{% endblock %}
