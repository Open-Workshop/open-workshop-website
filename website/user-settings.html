{% extends 'html-partials/standart.html' %}
{% block content %}
  <div style="margin: 2pt; display: flex; flex-direction: column; align-items: center;">
    {% if user_access.any %}
    <article class="user-settings-cont">
        <div class="navig-user-setting-menu">
          <h2>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h2>
          <button id="page-profile-button" onclick="switchSettingsPage('profile')">–ü—Ä–æ—Ñ–∏–ª—å</button>
          {% if user_access.my or user_access.admin %}
          <button id="page-integrate-button" onclick="switchSettingsPage('integrate')">–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è</button>
          {% endif %}
          <button id="page-save-button" style="margin-top: 30pt;" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div style="width: 100%;">
          <div id="page-profile-div" class="user-container-settings">
            <div class="user-left-bar">
              <div class="wrapper" style="width: 100%; max-width: 150pt;">
                <div class="user-avatar-box">
                    <img startdata="{{ user_data.general.avatar_url }}" src="{{ user_data.general.avatar_url }}" alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" id="user-avatar-img" style="width: 100%;" class="user-avatar{% if user_access.avatar %} user-avatar-e{% endif %}"{% if user_access.avatar %} onclick="document.getElementById('file-select-avatar').click();"{% endif %}>
      
                    {% if user_access.avatar %}
                    <img class="user-edit-icon user-edit-icon-e" src="/assets/images/icon-edit.svg" alt="–í—ã–±—Ä–∞—Ç—å –∞–≤–∞—Ç–∞—Ä">
                    {% endif %}
                    <input type="file" accept=".png, .jpg" style="display: none;" id="file-select-avatar">
                </div>
                {% if user_access.avatar %}
                <div style="cursor: pointer; height: auto;" class="independence-mods-selector" onclick="document.getElementById('reset-avatar-checkbox').click();">
                  <input class="input-checkbox" style="margin: 4pt;" onchange="" id="reset-avatar-checkbox" type="checkbox">
                  <label style="margin-left: 2pt; cursor: pointer; margin-top: 1pt;">–°–±—Ä–æ—Å–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
                </div>
                {% endif %}
                
                {% if user_access.mute %}
                <div class="medium-6 columns">
                  <input style="width: 100%;" id="mute-datetime" type="datetime-local"{% if user_data.general.mute %} startdata="{{ user_data.general.mute_js }}" value="{{ user_data.general.mute_js }}"{% endif %} class='date'>
                </div>
                <style>
                  input.date{
                    margin-top: 5pt;
                    border-radius: 5px;
                    height: auto;
                    transition: all ease 200ms;
                    box-shadow: 0px 0px 3px 3px #4a4a4a;
                    background: #313131;
                    color: white;
                  }

                  input.date:hover{
                    box-shadow:0px 0px 5px 5px rgb(165, 165, 165);
                  }
                </style>
                {% endif %}

                <script>
                  {% if user_access.mute %}
                  document.getElementById('mute-datetime').min = new Date().toLocaleString("sv-SE", {
                      year: "numeric",
                      month: "2-digit",
                      day: "2-digit",
                      hour: "2-digit",
                      minute: "2-digit",
                      second: "2-digit"
                  }).replace(" ", "T");
                  {% endif %}

                  const input = document.getElementById('file-select-avatar');
                  const img = document.getElementById('user-avatar-img');

                  input.addEventListener('change', function() {
                    const file = input.files[0];

                    //Initiate the JavaScript Image object.
                    const reader = new FileReader();

                    //Read the contents of Image File.
                    reader.readAsDataURL(file);
                    reader.onload = function (e) {

                      var image = new Image();

                      //Set the Base64 string return from FileReader as source.
                      image.src = e.target.result;

                      //Validate the File Height and Width.
                      image.onload = function () {
                        var height = this.height;
                        var width = this.width;
                        
                        if (Math.abs(width / height - 1) > 0.05) {
                          input.value = '';  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º
                          img.src = img.getAttribute("startdata")
                          banner_error_a = {
                            title: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–≤–∞—Ç–∞—Ä!',
                            text: '–ê–≤–∞—Ç–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–º!',
                            theme: 'warning',
                            autohide: true,
                            interval: 6000
                          };

                          new Toast(banner_error_a)
                        } else if (width < 60 || height < 60) {     // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ < 60px
                          input.value = '';  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º
                          img.src = img.getAttribute("startdata")
                          banner_error_a = {
                            title: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–≤–∞—Ç–∞—Ä!',
                            text: '–°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞!',
                            theme: 'warning',
                            autohide: true,
                            interval: 6000
                          };

                          new Toast(banner_error_a)
                        } else if (file.size > 2 * 1024 * 1024) {
                          input.value = '';  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª, –µ—Å–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏—è–º
                          img.src = img.getAttribute("startdata")
                          banner_error_a = {
                            title: '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–≤–∞—Ç–∞—Ä!',
                            text: '–ê–≤–∞—Ç–∞—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç—è–∂–µ–ª–µ–µ 2–ú–ë!',
                            theme: 'warning',
                            autohide: true,
                            interval: 6000
                          };

                          new Toast(banner_error_a)
                        } else {
                          img.src = e.target.result;
                        }
                      };
                    }
                  });
                </script>
              </div>
            </div>
    
            <div style="width: 100%">
              <h1 id="mod-name-title" style="padding-bottom: 3pt; padding-bottom: 3pt; display: flex; justify-content: space-between; align-items: center;" translate="no">
                <div {% if user_access.grade or user_access.username %}style="display: flex; align-items: center;"{% endif %}>
                  {% if not user_access.username %}
                  {{ user_data.general.username }}
                  {% endif %}

                  {% if user_access.username %}
                  <input class="edit-username" maxlength="18" startdata="{{ user_data.general.username }}" id="username" value="{{ user_data.general.username }}" name="username" oninput="usernameEditEvent()">
                  {% endif %}

                  {% if user_access.grade %}
                  <input id="grade" placeholder="–ó–≤–∞–Ω–∏–µ..." maxlength="18" startdata="{{ user_data.general.grade }}" type="text" title="–ó–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞—Å–ª—É–≥–∏)" class="tag-link-red grade-edit" value="{{ user_data.general.grade }}" oninput="gradeEditEvent()">
                  {% endif %}
                  {% if not user_access.grade and user_data.general.grade|length >0 %}
                  <a title="–ó–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∑–∞—Å–ª—É–≥–∏)" style="padding-top: 0; padding-bottom: 0;" class="tag-link-red" translate="no">{{ user_data.general.grade }}</a>
                  {% endif %}

                  <script>
                    const usernameElement = document.getElementById('username');

                    usernameEditEvent()
                    function usernameEditEvent() {
                      if (usernameElement) {
                        const myText = usernameElement.value;

                        if (myText.length >= 18 || myText.length <= 1) {
                          usernameElement.classList.add('limit');
                        } else {
                          usernameElement.classList.remove('limit')
                        }

                        usernameElement.style.width = 0;
                        usernameElement.style.width = usernameElement.scrollWidth+5 + "px";
                      }
                    }
                    
                    const gradeElement = document.getElementById('grade');

                    gradeEditEvent()
                    function gradeEditEvent() {
                      if (gradeElement) {
                        const myText = gradeElement.value;

                        gradeElement.style.width = 0;
                        gradeElement.style.width = gradeElement.scrollWidth+5 + "px";
                      }
                    }
                  </script>
                </div>
              </h1>
              <h4 id="mod-tags-title">
                  <a title="–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏" id="date_creation_a_tag" datejs="" class="tag-link" translate="no">üìù{{ user_data.general.registration_date }}</a>
                  <div title="–†–µ–ø—É—Ç–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {{ user_data.general.reputation }}" class="tag-link-blue" translate="no">
                    {% if user_data.general.reputation < 0 %}üëø{% endif %}
                    {% if user_data.general.reputation > 0 %}üòá{% endif %}
                    <a class="tag-link" translate="no">{{ user_data.general.reputation }}</a>
                    {% if user_data.general.reputation == 0 %}üëÄ{% endif %}
                  </div>
    
                  {% if user_data.general.author_mods > 0 %}
                  <a title="–ê–≤—Ç–æ—Ä {{ user_data.general.author_mods }} –º–æ–¥–æ–≤" class="tag-link-orange" translate="no">üì§{{ user_data.general.author_mods }}</a>
                  {% endif %}
    
                  {% if user_data.general.comments > 0 %}
                  <a title="–û—Å—Ç–∞–≤–∏–ª {{ user_data.general.comments }} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤" class="tag-link-orange" translate="no">‚úèÔ∏è{{ user_data.general.comments }}</a>
                  {% endif %}
              </h4>
    
              {% if user_access.about %}
              <textarea class="edit-about-settings" placeholder="–û–±–æ –º–Ω–µ..." startdata="{% if user_data.general.about_enable %}{{ user_data.general.about }}{% endif %}" title="–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–º. –£—á–∏—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª–∞ —Å–∞–π—Ç–∞ –∏–Ω–∞—á–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º—ã!" style="height: 51px;" id="mod-description">{% if user_data.general.about_enable %}{{ user_data.general.about }}{% endif %}</textarea>
              {% endif %}
              {% if not user_access.about and user_data.general.about_enable %}
              <article id="mod-description">{{ user_data.general.about }}</article>
              {% endif %}

              <script>
                const tx = document.getElementsByTagName("textarea");
                for (let i = 0; i < tx.length; i++) {
                  tx[i].setAttribute("style", "height:" + (tx[i].scrollHeight) + "px;overflow-y:hidden;");
                  tx[i].addEventListener("input", OnInput, false);
                }

                function OnInput() {
                  this.style.height = 0;
                  this.style.height = (this.scrollHeight) + "px";

                  console.log(this.value.length)
                  if (this.value.length > 512) {
                    this.classList.add('limit');
                  } else {
                    this.classList.remove('limit')
                  }
                }
              </script>
            </div>
          </div>
          {% if user_access.my or user_access.admin %}
          <div id="page-integrate-div" style="flex-direction: column;" class="user-container-settings">
            <button class="service{% if not user_access.my %} sconnected{% endif %}" {% if user_access.my and not user_data.private.yandex %}onclick="serviceConnect('/api/accounts/authorization/yandex/link')"{% endif %}{% if user_access.my and user_data.private.yandex %}onclick="serviceDisconnect('yandex')"{% endif %}>
              <img style="width: 30pt;" src="/assets/images/yandex.svg" alt="Yandex logo">
              
              <p>
                {% if user_access.my %}
                  {% if user_data.private.yandex %}–û—Ç–∫–ª—é—á–∏—Ç—å{% endif %}
                  {% if not user_data.private.yandex %}–ü–æ–¥–∫–ª—é—á–∏—Ç—å{% endif %}
                {% endif %}
                {% if not user_access.my %}
                  {% if not user_data.private.yandex %}–û—Ç–∫–ª—é—á–µ–Ω{% endif %}
                  {% if user_data.private.yandex %}–ü–æ–¥–∫–ª—é—á–µ–Ω{% endif %}
                {% endif %}
              </p>
            </button>
            <button class="service{% if not user_access.my %} sconnected{% endif %}" {% if user_access.my and not user_data.private.google %}onclick="serviceConnect('/api/accounts/authorization/google/link')"{% endif %}{% if user_access.my and user_data.private.google %}onclick="serviceDisconnect('google')"{% endif %}>
              <img style="width: 30pt;" src="/assets/images/google.svg" alt="Google logo">
              
              <p>
                {% if user_access.my %}
                  {% if user_data.private.google %}–û—Ç–∫–ª—é—á–∏—Ç—å{% endif %}
                  {% if not user_data.private.google %}–ü–æ–¥–∫–ª—é—á–∏—Ç—å{% endif %}
                {% endif %}
                {% if not user_access.my %}
                  {% if not user_data.private.google %}–û—Ç–∫–ª—é—á–µ–Ω{% endif %}
                  {% if user_data.private.google %}–ü–æ–¥–∫–ª—é—á–µ–Ω{% endif %}
                {% endif %}
              </p>
            </button>
          </div>
          {% endif %}

          <script>
            switchSettingsPage(OpenWS.getFromDict(OpenWS.urlParams(window.location.href), "page", 'profile'));

            function switchSettingsPage(newPage) {
              object = ['profile', 'integrate']
              for (const property_number in object) {
                const property = object[property_number];
                const div = document.getElementById('page-'+property+'-div');
                const button = document.getElementById('page-'+property+'-button');
                console.log(div, button, 'page-'+property+'-div', 'page-'+property+'-button');
                if (newPage == property) {
                  div.classList.remove('nov-visib');
                  button.disabled = true;
                } else {
                  div.classList.add('nov-visib');
                  button.disabled = false;
                };
              }
              document.getElementById('page-save-button').disabled = (newPage == 'integrate');

              const res = OpenWS.reselectParam("page", newPage)
              if (res != false) {
                window.history.pushState('page'+newPage, 'Open Workshop', res);
              }
            };
          </script>
          <style>
            .nov-visib {
              display: none;
            }
            button.service {
              cursor: pointer;
              border: none;
              width: 100%;
              background: bisque;
              border-radius: 5pt;
              padding-top: 2pt;
              padding-bottom: 2pt;
              padding-right: 2pt;
              display: flex;
              align-items: center;
              margin: 3pt;
              padding-left: 1pt;
            }
            button.sconnected {
              cursor: auto;
              pointer-events: none;
              background: #ffad4b;
            }
            button.service > p {
              font-size: 20pt;
              font-family: cursive;
            }
          </style>
        </div>
        <script>
          function saveProfile() {
            let data = {}

            url = '/api/accounts/profile/edit/{{ user_data.general.id }}?'
            const formData = new FormData();

            const username = document.getElementById('username');
            if (username && username.value != username.getAttribute("startdata")) {
              url += "username="+username.value+"&"
            }
            const grade = document.getElementById('grade');
            if (grade && grade.value != grade.getAttribute("startdata")) {
              url += "grade="+grade.value+"&"
            }
            const about = document.getElementById('mod-description');
            if (about && about.value != about.getAttribute("startdata")) {
              url += "about="+about.value+"&"
            }
            const input = document.getElementById('file-select-avatar');
            if (input && input.files[0]) {
              formData.append('avatar', input.files[0]);
            } else {
              formData.append('avatar', '');
            }

            const emptyAvatar = document.getElementById('reset-avatar-checkbox');
            if (emptyAvatar && emptyAvatar.checked) {
              url += "empty_avatar="+emptyAvatar.checked+"&"
            }
            const mute = document.getElementById('mute-datetime');
            if (mute && ((mute.hasAttribute("startdata") && mute.value != mute.getAttribute("startdata")) || (mute.value && !mute.hasAttribute("startdata")))) {
              url += "mute="+mute.value+"&"
            }

            console.log(url)

            fetch(url, {
              method: 'POST',
              body: formData
            }).then(response => {
              if (response.status === 202) {
                console.log('–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ —Ä–∞–≤–µ–Ω 202!');
                location.reload();
              } else {
                console.log('–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞ –Ω–µ —Ä–∞–≤–µ–Ω 202');
                response.text().then(text => {
                  banner_error_a = {
                    title: '–û—à–∏–±–∫–∞',
                    text: text.substring(1, text.length - 1),
                    theme: 'warning',
                    autohide: true,
                    interval: 6000
                  };

                  new Toast(banner_error_a);
                });
              }
            }).catch(error => {
              console.error('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ' + error);
              banner_error_a = {
                title: '–û—à–∏–±–∫–∞',
                text: '–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞...',
                theme: 'danger',
                autohide: true,
                interval: 6000
              };

              new Toast(banner_error_a)
            });
          }
        </script>
    </article>
    {% endif %}
    {% if not user_access.any %}
    <article class="user-settings-cont">
      <h1 style="text-align: center;">
        {% if user_access.my %}–ü–æ—Ö–æ–∂–µ –∫ –≤–∞–º –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–∞–Ω–∫—Ü–∏–∏ –∏ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å :({% endif %}
        {% if not user_access.my %}–í—ã –Ω–µ –∏–º–µ–µ—Ç–µ –ø—Ä–∞–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ñ–∏–ª—å!{% endif %}
      </h1>
    </article>
    {% endif %}
  </div>
{% endblock %}

{% block title %}
{{ user_data.general.username }} - user settings
{% endblock %}

{% block description %}
–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ user_data.general.username }} –≤ Open Workshop
{% endblock %}


{% block metaimage %}
{{ user_data.general.avatar_url }}
{% endblock %}

