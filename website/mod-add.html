{% extends 'html-partials/standart.html' %}
{% block content %}
  <div style="display: flex; flex-direction: column; align-items: center;">
    <article id="main-container">
      <h1 style="color: white; font-size: 25pt;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥ üòâ</h1>
      
      <div style="width: 100%; margin-top: 5pt; background: rgba(0, 0, 0, 0.5);">
        <input displaylimit class="edit-username" style="padding-left: 7pt; width: 100%; border: none; border-radius: 0;" placeholder="–≠—Ç–æ—Ç –º–æ–¥ –ø—Ä–æ–∑–≤–∞–ª–∏..." maxlength="60" minlength="1" id="mod-name-title" name="mod-name-title">
      </div>

      {% include 'html-partials/desc-edit.html' %}

      {% include "html-partials/new-game-selector.html" %}

      {% include "html-partials/upload-file.html" %}

      <style>
        button.add-mod {
          height: 45px;
          width: 180px;
          border-radius: 10pt;
          margin-top: 5pt;
          font-size: 20pt;
          border: none;
          background: #555555;
          color: white;
          margin-bottom: 3pt;
          transition: all 0.2s;
        }
        button.add-mod:hover {
          background: #4d4d4d;
          font-size: 20.5pt;
        }
        button.add-mod:active {
          background: #444444;
          font-size: 19.5pt;
        }

        article#main-container {
          max-width: 300pt;
          width: 100%;
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 0;
        }
        @media screen and (min-width: 459px) {
          article#main-container {
            scale: 1.1;
            margin-top: 20pt;
          }
        }
      </style>
      <button class="add-mod" onclick="uploadNewMod()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>

      {% include "html-partials/green-bar.html" %}
    </article>
  </div>

  <script>
    const titleMod = $('input#mod-name-title')
    const descMod = $('textarea#editing-short')
    const fileMod = $('input#input-mod-file-upload')
    const gameOwnerMod = $('div.select-game-menu')

    function uploadNewMod() {
      function printError(targetText) {
        banner_error_a = {
          title: '–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',
          text: targetText,
          theme: 'warning',
          autohide: true,
          interval: 6000
        };

        new Toast(banner_error_a);
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∞
      if (titleMod.val().length <= 0) {
        printError("–ù–µ —É–∫–∞–∑–∞–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–∞!")
        return
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è
      const textDesc = descMod.val()
      if (textDesc.length <= 0) {
        printError("–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–æ!")
        return
      } else if (textDesc.length > 256) {
        printError("–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–∞ —Å–ª–∏–∏–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ!")
        return
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏–≥—Ä—ã-—Å–æ–∑–¥–∞—Ç–µ–ª—è
      if (!gameOwnerMod.attr('gameid')) {
        printError("–ò–≥—Ä–∞-–≤–ª–∞–¥–µ–ª–µ—Ü –Ω–µ –≤—ã–±—Ä–∞–Ω–∞!")
        return
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞
      if (fileMod.get(0).files.length <= 0) {
        printError("–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª –ø–µ—Ä–≤–æ–π –≤–µ—Ä—Å–∏–∏!")
        return
      }

      // –ò—Å–ø–æ–ª–Ω—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      uploadStart();

      var formData = new FormData();
      formData.append('mod_source', 'local');
      formData.append('mod_game', gameOwnerMod.val());
      formData.append('mod_name', titleMod.val());
      formData.append('mod_short_description', descMod.val());
      formData.append('mod_description', descMod.val());
      formData.append('mod_public', '2');
      formData.append('mod_file', fileMod.prop('files')[0]);

      var xhr = new XMLHttpRequest();

      xhr.upload.addEventListener('progress', function(event) {
        if (event.lengthComputable) {
          progressUpdate((event.loaded / event.total) * 100)
        }
      });

      xhr.onload = function() {
        if (xhr.status != 200) { // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
          // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
          banner_error_a = {
            title: '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ('+xhr.status+')',
            text: xhr.responseText,//.substring(1, text.length - 1),
            theme: 'warning',
            autohide: true,
            interval: 6000
          };

          new Toast(banner_error_a);
        } else {
          // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
          window.location.href = `/mod/${xhr.responseText}/edit`; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        }
        uploadComplete()
      };

      xhr.onerror = function() {
        // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
        banner_error_a = {
          title: '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞',
          text: xhr.responseText,
          theme: 'danger',
          autohide: true,
          interval: 6000
        };

        new Toast(banner_error_a);
        bar.hide()
      };

      xhr.open('POST', "/api/accounts/add/mod", true);
      xhr.send(formData)
    }
  </script>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/prism/1.23.0/prism.min.js'></script>
  <script src="/assets/scripts/ow-logic.js"></script>
  <script src="/assets/scripts/vendors/desc-edit.js"></script>
  <script src="/assets/scripts/ow-prism.js"></script>
  <link rel="stylesheet" href="/assets/styles/vendors/ow-language.css">
{% endblock %}


{% block title %}
OW: Add mod
{% endblock %}

{% block description %}
–î–æ–±–∞–≤—å—Ç–µ –º–æ–¥ –≤ —Å–≤–æ–±–æ–¥–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ Open Workshop!
{% endblock %}
