/**
 * Toast (https://github.com/itchief/ui-components/tree/master/toast)
 * Copyright 2020 - 2021 Alexander Maltsev
 * Licensed under MIT (https://github.com/itchief/ui-components/blob/master/LICENSE)
 **/

class Toast {
    constructor(params) {
      this._title = params['title'] === false ? false : params['title'] || 'Title';
      this._text = params['text'] || 'Message...';
      this._theme = params['theme'] || 'default';
      this._autohide = params['autohide'] && true;
      this._interval = +params['interval'] || 5000;
      this._link = params['link'] || '';
      this._create();
      if (this._autohide) {
        const header = this._el.querySelector('.toast__header');
        if (header) {
          this._el.classList.add('toast_temporary');
          this._el.style.setProperty('--toast-lifetime', `${this._interval}ms`);
        }
      }
      this._el.addEventListener('click', (e) => {
        if (e.target.closest('.toast__close')) {
          this._hide();
        }
      });
      this._show();
    }
    _show() {
      this._el.classList.add('toast_showing');
      this._el.classList.add('toast_show');
      window.setTimeout(() => {
        this._el.classList.remove('toast_showing');
      });
      if (this._autohide) {
        setTimeout(() => {
          this._hide();
        }, this._interval);
      }
    }
    _hide() {
      this._el.classList.add('toast_showing');
      this._el.addEventListener('transitionend', () => {
        this._el.classList.remove('toast_showing');
        this._el.classList.remove('toast_show');
        this._el.remove();
      }, {
        once: true
      });
      const event = new CustomEvent('hide.toast', {
        detail: {
          target: this._el
        }
      });
      document.dispatchEvent(event);
    }
    _create() {
      const el = document.createElement('div');
      el.classList.add('toast');
      el.classList.add(`toast_${this._theme}`);
      const html = '<div class="toast__header"><span class="toast__title"></span><button class="toast__close" type="button" aria-label="Закрыть"><img src="/assets/images/cancel-mini.svg" alt=""></button></div><div class="toast__body"></div>';
      el.innerHTML = html;
      const header = el.querySelector('.toast__header');
      const titleEl = el.querySelector('.toast__title');
      if (this._title) {
        titleEl.textContent = this._title;
      } else {
        el.classList.add('toast_message');
        header.classList.add('toast__header_empty');
        titleEl.remove();
      }
      el.querySelector('.toast__body').textContent = this._text;
      if (this._link) {
        el.querySelector('.toast__body').setAttribute("onclick", "adLink(\'"+this._link+"\')");
        el.querySelector('.toast__body').classList.add('toast_link');
      }
      this._el = el;
      if (!document.querySelector('.toast-container')) {
        const container = document.createElement('div');
        container.classList.add('toast-container');
        document.body.append(container);
      }
      document.querySelector('.toast-container').append(this._el);
    }
  }
